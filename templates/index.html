<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="icon" href="/templates/icon.ico" type="image/x-icon">
    <title>MP3 → MIDI Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/style.css">
  </head>
  <body class="text-gray-200 min-h-screen flex items-center justify-center">
    <div class="w-full max-w-6xl mx-auto px-4 py-8">
      {% if system_info %}
      <div class="bg-gray-800/80 backdrop-blur-md p-6 rounded-2xl shadow-lg border border-gray-700 hover-effect mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="flex items-center gap-2">
            <span class="text-gray-400 text-sm font-semibold min-w-[60px]">Host:</span>
            <span class="text-gray-200 text-sm flex-1 break-words">{{ system_info.host_name }}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-gray-400 text-sm font-semibold min-w-[60px]">CPU:</span>
            <span class="text-gray-200 text-sm flex-1 break-words">{{ system_info.cpu }}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-gray-400 text-sm font-semibold min-w-[60px]">GPU:</span>
            <span class="text-gray-200 text-sm flex-1 break-words">{{ system_info.gpu }}</span>
          </div>
        </div>
      </div>
      {% endif %}
      
      <div class="tab-container">
        <button class="tab-button active" data-tab="converter">Converter</button>
        <button class="tab-button" data-tab="history">History</button>
      </div>
      
      <div id="converter-tab" class="tab-content active">
      <div class="flex flex-col lg:flex-row lg:items-start gap-6">

        <div class="main-card bg-gray-800/80 backdrop-blur-md p-8 rounded-2xl shadow-lg text-center w-full h-full border border-gray-700 hover-effect">
          <h2 class="text-xl font-semibold text-white">MP3 → MIDI CONVERTER</h2>

          <div class="flex items-center justify-center space-x-4 mb-4">
            <span class="text-white text-sm">Model: Transkun</span>
            <div class="flex items-center space-x-2">
              <span class="text-gray-400 text-xs">CPU</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="device-toggle" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
              </label>
              <span class="text-gray-400 text-xs">CUDA</span>
            </div>
            <button type="button" id="sheets-settings-btn" class="inline-flex items-center justify-center text-center text-sm font-medium px-4 py-2 rounded-lg border border-purple-700 bg-purple-600/20 text-purple-300 hover:bg-purple-600/30 hover-effect">
              Settings
            </button>
          </div>

          <form method="post" enctype="multipart/form-data" class="space-y-4" id="file-upload-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="file" name="file" accept=".mp3"
              class="block w-full text-sm text-gray-200 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:text-white"/>
            <input type="hidden" name="conversion_library" id="conversion-library-hidden" value="transkun" />
            <input type="hidden" name="device" id="device-input" value="cuda" />
                <button type="submit" id="convert-button" class="inline-flex items-center justify-center w-full text-center text-sm font-medium px-4 py-2 rounded-lg border border-blue-700 bg-blue-600/20 text-blue-300 hover:bg-blue-600/30 hover-effect">Convert MP3</button>
          </form>

          <form method="post" class="space-y-4 mt-4" id="url-upload-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="text" name="media_url" placeholder="Paste YouTube/TikTok/Discord link"
                   class="block w-full p-2 rounded-lg border border-gray-600 bg-gray-700 text-gray-200 placeholder-gray-400 hover-effect"/>
            <input type="hidden" name="conversion_library" id="conversion-library-hidden-youtube" value="transkun" />
            <input type="hidden" name="device" id="device-input-youtube" value="cuda" />
                <button type="submit" id="convert-button-youtube" class="inline-flex items-center justify-center w-full text-center text-sm font-medium px-4 py-2 rounded-lg border border-blue-700 bg-blue-600/20 text-blue-300 hover:bg-blue-600/30 hover-effect">Convert Link</button>
          </form>

          <div id="videoPreview" class="mt-4" style="display: none;">
            <h2 class="text-lg mb-2">Preview:</h2>
            <div id="videoPreviewContent"></div>
          </div>
          
          {% if video_id %}
          <div class="mt-4 hover-effect">
            <h2 class="text-lg mb-2">Preview:</h2>
            <iframe width="100%" height="200" src="https://www.youtube.com/embed/{{ video_id }}" title="YouTube video player" frameborder="0" allowfullscreen class="rounded-lg shadow-lg hover-effect"></iframe>
          </div>
          {% endif %}

          <div id="progressText" style="display: none; margin-top: 16px; margin-bottom: 8px; font-size: 13px; color: #e5e7eb;">Processing...</div>
          <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
          </div>


          {% if conversion_time and midi_name %}
          <div class="conversion-time hover-effect">
            Done in: {{ conversion_time }} s.
            <a href="{{ url_for('download_file', filename=midi_name) }}" class="underline hover-effect">Download MIDI</a>
          </div>
          {% endif %}

          {% with messages = get_flashed_messages() %}
            {% if messages %}
              <div class="error-message hover-effect">{{ messages[0] }}</div>
            {% endif %}
          {% endwith %}
        </div>

        <aside class="w-full h-full">
          <div class="history-card bg-gray-800/80 backdrop-blur-md p-6 rounded-2xl shadow-lg border border-gray-700 h-full flex flex-col hover-effect">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-xl font-semibold text-white">Conversion History</h2>
              <span class="text-xs text-gray-400">Recent</span>
            </div>

            {% set max_items = 32 %}

            <div id="history-list" class="flex-1 overflow-y-auto pr-0 space-y-3 hide-scrollbar">
              {% if history and history|length > 0 %}
                {% for item in history[:max_items] %}
                  <div class="history-item p-3 rounded-xl bg-gray-700/40 border border-gray-700 hover-effect flex flex-col min-h-0">
                    <div class="flex items-start justify-between gap-3">
                      <div class="flex items-start gap-3">
                        {% if item.type == 'youtube' %}
                          <span class="px-2 py-0.5 text-[10px] rounded-full bg-red-600/30 text-red-300 border border-red-700">YouTube</span>
                        {% elif item.type == 'tiktok' %}
                          <span class="px-2 py-0.5 text-[10px] rounded-full bg-purple-600/30 text-purple-200 border border-purple-700">TikTok</span>
                        {% elif item.type == 'discord' %}
                          <span class="px-2 py-0.5 text-[10px] rounded-full bg-indigo-600/30 text-indigo-300 border border-indigo-700">Discord</span>
                        {% else %}
                          <span class="px-2 py-0.5 text-[10px] rounded-full bg-indigo-600/30 text-indigo-300 border border-indigo-700">MP3</span>
                        {% endif %}
                      </div>
                      <button class="delete-history-btn px-2 py-0.5 text-[10px] rounded-full bg-red-600/30 text-red-300 border border-red-700 hover:bg-red-600/50 hover-effect" data-timestamp="{{ item.timestamp }}" title="Delete">
                        Delete
                      </button>
                    </div>
                    <div class="mt-2 space-y-2 text-sm flex-1 flex flex-col min-h-0">
                      {% if item.type == 'youtube' %}
                        {% if item.video_id %}
                          <a href="https://www.youtube.com/watch?v={{ item.video_id }}" target="_blank" rel="noopener" class="block hover-effect">
                            <img class="w-full rounded-lg border border-gray-700 hover:opacity-90"
                                 src="https://img.youtube.com/vi/{{ item.video_id }}/mqdefault.jpg"
                                 alt="thumb" loading="lazy" style="max-height: 180px; object-fit: cover;" 
                                 onerror="this.onerror=null; this.src='/templates/notfound.jpg';" />
                          </a>
                        {% else %}
                          <div class="block hover-effect">
                            <img src="/templates/notfound.jpg" alt="thumb" loading="lazy" class="w-full rounded-lg border border-gray-700" style="max-height: 180px; object-fit: cover;" />
                          </div>
                        {% endif %}
                    
                        {% if item.video_title %}
                          <div class="text-gray-300">
                            <a class="underline hover-effect"
                               href="{% if item.video_id %}https://www.youtube.com/watch?v={{ item.video_id }}{% else %}{{ item.youtube_url }}{% endif %}"
                               target="_blank" rel="noopener">{{ item.video_title }}</a>
                          </div>
                        {% elif item.youtube_url %}
                          <div class="text-gray-300">
                            <a class="underline hover-effect" href="{{ item.youtube_url }}" target="_blank" rel="noopener">{{ item.youtube_url }}</a>
                          </div>
                        {% endif %}
                    
                      {% elif item.type == 'tiktok' %}
                        {% if item.thumbnail_url and item.thumbnail_url.strip() %}
                          <a href="{{ item.tiktok_url }}" target="_blank" rel="noopener" class="block hover-effect">
                            <img src="{{ item.thumbnail_url }}"
                                alt="thumb"
                                loading="lazy"
                                style="width:100%; max-height: 180px; object-fit:cover; border-radius:0.5rem; border:1px solid #374151;" 
                                onerror="this.onerror=null; this.src='/templates/notfound.jpg'; this.style.borderRadius='0.5rem';" />
                          </a>
                        {% else %}
                          <div class="block hover-effect">
                            <img src="/templates/notfound.jpg" alt="thumb" loading="lazy" class="w-full rounded-lg border border-gray-700" style="max-height: 180px; object-fit: cover;" />
                          </div>
                        {% endif %}
                        <div class="text-gray-300" title="{{ item.video_title }}">
                          <a class="underline hover-effect" href="{{ item.tiktok_url }}" target="_blank" rel="noopener">
                            {{ item.video_title or item.tiktok_url }}
                          </a>
                        </div>
                    
                      {% elif item.type == 'discord' %}
                        {% if item.thumbnail_url and item.thumbnail_url.strip() %}
                          <a href="{{ item.discord_url }}" target="_blank" rel="noopener" class="block hover-effect">
                            <img src="{{ item.thumbnail_url }}"
                                alt="thumb"
                                loading="lazy"
                                style="width:100%; max-height: 180px; object-fit:cover; border-radius:0.5rem; border:1px solid #374151;" 
                                onerror="this.onerror=null; this.src='/templates/notfound.jpg'; this.style.borderRadius='0.5rem';" />
                          </a>
                        {% else %}
                          <div class="block hover-effect">
                            <img src="/templates/notfound.jpg" alt="thumb" loading="lazy" class="w-full rounded-lg border border-gray-700" style="max-height: 180px; object-fit: cover;" />
                          </div>
                        {% endif %}
                        <div class="text-gray-300" title="{{ item.video_title }}">
                          <a class="underline hover-effect" href="{{ item.discord_url }}" target="_blank" rel="noopener">
                            {{ item.video_title or item.discord_url }}
                          </a>
                        </div>
                    
                      {% else %}
                        <div class="block hover-effect">
                          <img src="/templates/notfound.jpg" alt="thumb" loading="lazy" class="w-full rounded-lg border border-gray-700" style="max-height: 180px; object-fit: cover;" />
                        </div>
                        <div class="text-gray-300">File:
                          {% if item.mp3_name %}
                            <a class="underline hover-effect" href="{{ url_for('serve_upload', filename=item.mp3_name) }}" target="_blank" rel="noopener">{{ item.mp3_name }}</a>
                          {% else %}—{% endif %}
                        </div>
                      {% endif %}
                    
                      <div class="mt-auto pt-2">
                        <div class="flex items-center justify-between text-xs text-gray-400 mb-2">
                          <span>Model: {{ item.library or '—' }}</span>
                          <span>Time: {{ item.conversion_time or '—' }}s</span>
                        </div>
                      {% if item.midi_name %}
                        <a class="inline-flex items-center justify-center w-full text-center text-sm font-medium px-3 py-2 rounded-lg border border-emerald-700 bg-emerald-600/20 text-emerald-300 hover:bg-emerald-600/30 hover-effect"
                           href="{{ url_for('download_file', filename=item.midi_name) }}" download>
                          Download MIDI
                        </a>
                        <div class="mt-1 flex gap-2">
                          <button data-midi-filename="{{ item.midi_name }}" class="view-tempo-btn flex-1 inline-flex items-center justify-center text-center text-sm font-medium px-3 py-2 rounded-lg border border-blue-700 bg-blue-600/20 text-blue-300 hover:bg-blue-600/30 hover-effect">
                            Convert to QWERTY
                          </button>
                          <button data-midi-filename="{{ item.midi_name }}" class="download-sheets-btn flex-1 inline-flex items-center justify-center text-center text-sm font-medium px-3 py-2 rounded-lg border border-purple-700 bg-purple-600/20 text-purple-300 hover:bg-purple-600/30 hover-effect">
                            Download Sheets
                          </button>
                        </div>
                      {% endif %}
                      </div>
                    </div>
                    
                  </div>
                {% endfor %}
              {% else %}
                <div class="text-gray-400 text-sm">Nothing here yet. Convert something first.</div>
              {% endif %}
            </div>
          </div>
        </aside>

      </div>
      </div>
      
      <div id="history-tab" class="tab-content">
        <div class="bg-gray-800/80 backdrop-blur-md p-4 rounded-2xl shadow-lg border border-gray-700">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-white">Full Conversion History</h2>
            <button id="refresh-history-btn" class="inline-flex items-center justify-center text-center text-xs font-medium px-3 py-1.5 rounded-lg border border-blue-700 bg-blue-600/20 text-blue-300 hover:bg-blue-600/30 hover-effect">
              Refresh
            </button>
          </div>
          
          <div class="mb-3">
            <input type="text" id="history-search-input" placeholder="Search history by title, URL, MIDI name, or type..." 
                   class="block w-full p-2 rounded-lg border border-gray-600 bg-gray-700 text-gray-200 placeholder-gray-400 hover-effect focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div id="full-history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[65vh] overflow-y-auto small-scrollbar items-stretch">
            <div class="text-center text-gray-400 py-6 col-span-full text-sm">Loading history...</div>
          </div>
        </div>
      </div>
      
    </div>

    <div id="sheets-settings-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
      <div class="bg-gray-800 rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto hide-scrollbar border border-gray-700 shadow-xl">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-white">QWERTY Sheet Converter Settings</h3>
          <button id="close-settings-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        
        <div class="space-y-4 text-white">
          <div>
            <label class="block mb-2">Resilience:</label>
            <input type="range" id="setting-resilience" min="0" max="12" value="2" class="w-full">
            <span id="resilience-value" class="text-sm text-gray-300">2</span>
          </div>
          
          <div>
            <label class="block mb-2">Place shifted notes at:</label>
            <select id="setting-place-shifted" class="bg-gray-700 text-white rounded px-3 py-2 w-full">
              <option value="start">Start</option>
              <option value="end">End</option>
            </select>
          </div>
          
          <div>
            <label class="block mb-2">Place out of range notes at:</label>
            <select id="setting-place-out-of-range" class="bg-gray-700 text-white rounded px-3 py-2 w-full">
              <option value="inorder">Inorder</option>
              <option value="start">Start</option>
              <option value="end">End</option>
            </select>
          </div>
          
          <div>
            <label class="block mb-2">Break lines how:</label>
            <select id="setting-break-lines-how" class="bg-gray-700 text-white rounded px-3 py-2 w-full">
              <option value="manually">Manually</option>
              <option value="realistic">Realistic</option>
            </select>
          </div>
          
          <div id="break-lines-every-container">
            <label class="block mb-2">Break lines every (beats):</label>
            <input type="range" id="setting-break-lines-every" min="1" max="32" value="4" class="w-full">
            <span id="break-lines-value" class="text-sm text-gray-300">4</span>
          </div>
          
          <div>
            <label class="block mb-2">Quantize (milliseconds):</label>
            <input type="range" id="setting-quantize" min="1" max="250" value="35" class="w-full">
            <span id="quantize-value" class="text-sm text-gray-300">35</span>
          </div>
          
          <div class="flex items-center">
            <input type="checkbox" id="setting-classic-chord-order" checked class="mr-2">
            <label for="setting-classic-chord-order">Classic chord order</label>
          </div>
          
          <div class="flex items-center">
            <input type="checkbox" id="setting-sequential-quantizes" class="mr-2">
            <label for="setting-sequential-quantizes">Sequential quantizes</label>
          </div>
          
          <div class="flex items-center">
            <input type="checkbox" id="setting-curly-braces" class="mr-2">
            <label for="setting-curly-braces">Curly braces for quantized chords</label>
          </div>
          
          <div class="flex items-center">
            <input type="checkbox" id="setting-include-out-of-range" checked class="mr-2">
            <label for="setting-include-out-of-range">Include out of range (ctrl) notes</label>
          </div>
          
          <div class="flex items-center">
            <input type="checkbox" id="setting-show-tempo-marks" checked class="mr-2">
            <label for="setting-show-tempo-marks">Show tempo/timing marks</label>
          </div>
          
          <div class="flex items-center">
            <input type="checkbox" id="setting-show-out-of-range-marks" checked class="mr-2">
            <label for="setting-show-out-of-range-marks">Show out of range (ctrl) text marks</label>
          </div>
          
          <div id="out-of-range-separator-container">
            <label class="block mb-2">Out of range separator:</label>
            <input type="text" id="setting-out-of-range-separator" value=":" maxlength="1" class="bg-gray-700 text-white rounded px-3 py-2 w-16">
          </div>
          
          <div class="flex items-center">
            <input type="checkbox" id="setting-show-bpm-changes" checked class="mr-2">
            <label for="setting-show-bpm-changes">Show BPM changes as comments</label>
          </div>
          
          <div class="flex items-center">
            <input type="checkbox" id="setting-auto-transpose" checked class="mr-2">
            <label for="setting-auto-transpose">Auto transpose (single)</label>
          </div>
        </div>
        
        <div class="mt-6 pt-4 border-t border-gray-700">
          <p class="text-base text-gray-200 text-center leading-relaxed">
            QWERTY Sheet Converter created by 
            <a href="https://github.com/ArijanJ" target="_blank" rel="noopener noreferrer" class="text-purple-400 hover:text-purple-300 underline font-medium">@ArijanJ</a>
            and 
            <a href="https://github.com/Albacusphetical" target="_blank" rel="noopener noreferrer" class="text-purple-400 hover:text-purple-300 underline font-medium">@Albacusphetical</a>
            <br>
            <a href="https://github.com/ArijanJ/midi-converter" target="_blank" rel="noopener noreferrer" class="text-purple-400 hover:text-purple-300 underline mt-1 inline-block font-medium">
              View source on GitHub
            </a>
          </p>
        </div>
        
        <div class="mt-6 flex gap-3">
          <button id="save-settings" class="flex-1 bg-purple-700 hover:bg-purple-600 text-white rounded-lg py-2 px-4 hover-effect">
            Save Settings
          </button>
          <button id="reset-settings" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white rounded-lg py-2 px-4 hover-effect">
            Reset to Defaults
          </button>
        </div>
      </div>
    </div>

    <div id="view-tempo-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
      <div id="tempo-modal-content" class="bg-gray-800 rounded-lg p-0.5 max-w-[95vw] w-full mx-2 max-h-[95vh] overflow-hidden border border-gray-700 shadow-xl flex flex-col relative">
        <div id="tempo-modal-buttons" class="absolute top-0 right-0 z-[100] flex items-center gap-2 pr-1 pt-1" style="pointer-events: auto;">
          <button id="transpose-mode-toggle" class="text-gray-400 hover:text-white text-xs px-2 py-1 rounded" style="background: transparent; cursor: pointer; font-size: 0.75rem; line-height: 1.5; height: 24px; display: flex; align-items: center; justify-content: center; pointer-events: auto; border: none;" title="Toggle between Auto and Multi transpose mode">Transpose Mode: Auto</button>
          <button id="copy-transposes-btn" class="text-gray-400 hover:text-white text-xs hidden" style="background: transparent; border: none; padding: 0; cursor: pointer; font-size: 0.75rem; line-height: 1.5; height: 24px; display: none; align-items: center; justify-content: center; pointer-events: auto;">Copy Transposes</button>
          <button id="copy-tempo-text" class="text-gray-400 hover:text-white text-xs" style="background: transparent; border: none; padding: 0; cursor: pointer; font-size: 0.75rem; line-height: 1.5; height: 24px; display: flex; align-items: center; justify-content: center; pointer-events: auto;">Copy</button>
          <button id="fullscreen-tempo-modal" class="text-gray-400 hover:text-white text-sm" style="background: transparent; border: none; padding: 0; cursor: pointer; line-height: 1.5; height: 24px; display: flex; align-items: center; justify-content: center; pointer-events: auto;" title="Fullscreen">⛶</button>
          <button id="close-tempo-modal" class="text-gray-400 hover:text-white text-xl" style="background: transparent; border: none; padding: 0; cursor: pointer; font-size: 0.75rem; line-height: 1.5; height: 24px; display: flex; align-items: center; justify-content: center; pointer-events: auto;">X;</button>
        </div>
        
        <div id="tempo-text-content" class="flex-1 overflow-auto hide-scrollbar bg-gray-900 rounded p-1 font-mono text-sm text-gray-200 border border-gray-700 leading-relaxed" style="white-space: pre; word-wrap: normal; overflow-wrap: normal;">
          <div class="text-center text-gray-400">Loading...</div>
        </div>
      </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
      <div class="bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 border border-gray-700 shadow-xl">
        <div class="flex items-center justify-between mb-4">
          <h3 id="modal-title" class="text-xl font-semibold text-white"></h3>
          <button id="modal-close" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        <p id="modal-message" class="text-gray-200 mb-6"></p>
        <div id="modal-buttons" class="flex gap-3 justify-end">
        </div>
      </div>
    </div>

    <script src="/static/js/modal.js"></script>
    <script src="/static/js/device.js"></script>
    <script src="/static/js/settings.js"></script>
    <script src="/static/js/sheets-utils.js"></script>
    <script src="/static/js/history.js"></script>
    <script src="/static/js/conversion.js"></script>
    <script src="/static/js/sheets-viewer.js"></script>
    <script src="/static/js/ui.js"></script>
  </body>
</html>