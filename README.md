# üéµ Audio Converter Web

A powerful web application for converting MP3 audio files to MIDI format using Transkun, with support for YouTube, TikTok, and Discord CDN link downloads. The application also includes a QWERTY sheet converter for MIDI files, allowing you to play music directly on your keyboard.

## ‚ú® Features

- üéπ **MP3 to MIDI Conversion**: Convert MP3 audio files to MIDI format using Transkun
- üì∫ **Multi-Platform Support**: Download and convert audio directly from YouTube, TikTok, and Discord CDN links
- ‚å®Ô∏è **QWERTY Sheet Converter**: Convert MIDI files to QWERTY keyboard sheet notation for easy playing
- üé® **Modern Web Interface**: Beautiful, responsive UI with real-time progress tracking
- üìú **Conversion History**: Track all your conversions with thumbnails and metadata, with delete functionality
- ‚öôÔ∏è **Customizable Settings**: Fine-tune QWERTY sheet conversion parameters
- üöÄ **Real-time Progress**: Monitor conversion progress with visual indicators
- üíæ **Download Management**: Easy download of MIDI and sheet files
- üéØ **Async Processing**: Non-blocking conversions for better user experience
- üîÑ **CUDA/CPU Toggle**: Switch between GPU (CUDA) and CPU processing with a simple toggle switch
- üåê **Auto-Browser Launch**: Automatically opens your browser when starting the application

## üìã Requirements

### System Requirements

- **Python**: [3.10.0](https://www.python.org/downloads/release/python-3100/)
- **GPU**: CUDA-capable GPU (recommended for faster conversion, but CPU works too)
- **FFmpeg**: [Required for audio processing](https://ffmpeg.org/download.html)
- **Transkun**: [Must be installed and available in your system PATH](https://github.com/Yujia-Yan/Transkun#model-cards)

### Python Dependencies

All Python dependencies are listed in `requirements.txt` and will be installed automatically.

## üöÄ Installation

### Step 1: Clone the Repository

```bash
git clone <repository-url>
cd audioconverter-web
```

### Step 2: Install Python Dependencies

**For RTX 50xx Series GPUs (CUDA 12.9):**

If you have an RTX 50xx series GPU, install PyTorch, torchvision, and torchaudio with CUDA 12.9 support first:

```bash
pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu129
```

**Important:** All three packages (torch, torchvision, torchaudio) must be installed from the same source to ensure compatibility.

Then install the remaining dependencies (excluding torch and torchaudio):

```bash
pip install -r requirements.txt --no-deps torch torchaudio
```

This ensures you use the CUDA 12.9 version of PyTorch and compatible torchaudio instead of the standard versions.

**For other GPUs or CPU-only:**

```bash
pip install -r requirements.txt
```

This will install:
- Flask (web framework)
- PyTorch (for GPU support)
- yt-dlp (for video downloads)
- pretty-midi (for MIDI processing)
- And other required packages

### Step 3: Install Transkun

Ensure Transkun is installed and accessible from your command line:

```bash
transkun --version
```

If not installed, follow the [Transkun installation guide](https://github.com/Yujia-Yan/Transkun).

### Step 4: Configure YouTube Cookies (Optional but Recommended)

**Note:** Cookies are only used for YouTube downloads. TikTok and Discord downloads do not require cookies.

For downloading restricted or age-restricted YouTube videos, you need to add your YouTube cookies to `cookies.txt`:

1. **Install a browser extension** to export cookies:
   - Chrome/Edge: [get NETSCAPE cookies by export](https://chromewebstore.google.com/detail/hlkenndednhfkekhgcdicdfddnkalmdm?utm_source=item-share-cb)
   - Firefox: [get NETSCAPE cookies by export](https://addons.mozilla.org/en-US/firefox/addon/cookie-editor/)

2. **Export cookies from YouTube:**
   - Navigate to [YouTube](https://www.youtube.com) in your browser
   - Click the extension icon
   - Select "Export" or "Get cookies.txt"
   - Choose to export for `.youtube.com` domain

3. **Save the cookies:**
   - Copy the exported cookies content
   - Paste it into `cookies.txt` in the project root directory
   - The file should be in NETSCAPE format (the extension will format it correctly)

4. **Verify the cookies file:**
   - The `cookies.txt` file should start with:
     ```
     # Netscape HTTP Cookie File
     # This file is generated by yt-dlp.  Do not edit.
     ```
   - It should contain cookies for `.youtube.com` domain

**Note:** Cookies expire after some time. If downloads start failing, re-export and update your `cookies.txt` file.

### Step 5: Install FFmpeg

FFmpeg is required for audio processing. Install it based on your operating system:

**Windows:**
- Download from [FFmpeg official website](https://ffmpeg.org/download.html)
- Extract and add to your system PATH
- Or use: `choco install ffmpeg` (if using Chocolatey)

**Linux:**
```bash
sudo apt-get update
sudo apt-get install ffmpeg
```

**macOS:**
```bash
brew install ffmpeg
```

### Step 6: Verify Installation

Run a quick test to ensure everything is set up correctly:

```bash
python -c "import torch; print('CUDA available:', torch.cuda.is_available())"
transkun --version
ffmpeg -version
```

## üíª Usage

### Web Interface

#### Option 1: Standard Flask Server

Run the Flask application:

```bash
python app.py
```

The application will start on `http://127.0.0.1:5000` and automatically open in your default browser.

#### Option 2: GUI Application

For a standalone window application:

```bash
python app_gui.py
```

This opens a native window with the web interface (requires `pywebview`).

### Using the Application

#### Device Selection (CUDA/CPU)

Before converting, you can choose your processing device:
- **Toggle Switch**: Located next to "Model: Transkun" in the interface
- **CPU Mode**: Left position - Use CPU for conversion (works on all systems)
- **CUDA Mode**: Right position - Use GPU for faster conversion (requires CUDA-capable GPU)
- **Auto-fallback**: If CUDA is selected but not available, the system automatically falls back to CPU
- **Preference Saved**: Your device preference is saved in browser local storage

#### 1. üì§ Upload MP3 File

- Select your preferred device (CPU or CUDA) using the toggle switch
- Click "Choose File" and select an MP3 file from your computer
- Click "Convert MP3" to start the conversion
- Wait for the conversion to complete
- Download your MIDI file

#### 2. üîó Convert from YouTube/TikTok/Discord

- Select your preferred device (CPU or CUDA) using the toggle switch
- Paste a YouTube, TikTok, or Discord CDN link in the input field
- Click "Convert Link"
- The application will:
  - Download the video/audio file
  - Convert it to MIDI format using your selected device
  - Display a preview with thumbnail (if available)
  - Provide download links

**Supported URL formats:**
- YouTube: `https://www.youtube.com/watch?v=...` or `https://youtu.be/...`
- TikTok: `https://www.tiktok.com/...` or `https://vm.tiktok.com/...`
- Discord: `https://cdn.discordapp.com/attachments/...` or `https://media.discordapp.net/attachments/...`

#### 3. ‚å®Ô∏è Convert MIDI to QWERTY Sheets

- After converting to MIDI, click "Convert to QWERTY" to view the sheet
- Or click "Download Sheets" to download the text file
- Customize conversion settings using the "Settings" button

### üéõÔ∏è QWERTY Sheet Settings

Access settings via the "Settings" button to customize:

- **Resilience**: Transposition sensitivity (0-12)
- **Note Placement**: Where to place shifted and out-of-range notes
- **Line Breaks**: Manual or automatic line breaking
- **Quantization**: Time threshold for grouping notes (milliseconds)
- **Chord Ordering**: Classic or custom chord ordering
- **Visual Markers**: Tempo marks, out-of-range indicators, BPM changes
- **Auto Transpose**: Automatically transpose to optimal key

## ‚öôÔ∏è Configuration

### Environment Variables

You can configure the application using environment variables:

| Variable | Description | Default |
|----------|-------------|---------|
| `SECRET_KEY` | Flask secret key for sessions | Auto-generated |
| `MAX_CONTENT_LENGTH_MB` | Maximum upload size in MB | 25 |
| `UPLOAD_FOLDER` | Folder for uploaded files | `uploads` |
| `CONVERTED_FOLDER` | Folder for converted files | `converted` |
| `FORCE_HTTPS` | Force HTTPS connections | `false` |

### Example Configuration

```bash
export SECRET_KEY="your-secret-key-here"
export MAX_CONTENT_LENGTH_MB=50
export UPLOAD_FOLDER="/path/to/uploads"
python app.py
```

## üìÅ Project Structure

```
audioconverter-web/
‚îú‚îÄ‚îÄ app.py                 # Main Flask application (auto-opens browser)
‚îú‚îÄ‚îÄ app_gui.py            # GUI wrapper using pywebview
‚îú‚îÄ‚îÄ midi_to_sheets.py     # MIDI to QWERTY sheet converter
‚îú‚îÄ‚îÄ requirements.txt      # Python dependencies
‚îú‚îÄ‚îÄ cookies.txt          # YouTube cookies file (optional)
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ index.html       # Web interface
‚îÇ   ‚îú‚îÄ‚îÄ icon.ico         # Application icon
‚îÇ   ‚îî‚îÄ‚îÄ notfound.jpg     # Placeholder image
‚îú‚îÄ‚îÄ uploads/             # Uploaded files directory
‚îú‚îÄ‚îÄ converted/           # Converted files directory
‚îú‚îÄ‚îÄ transkun/           # Transkun transcription module
‚îú‚îÄ‚îÄ resources/          # Model files and resources
‚îî‚îÄ‚îÄ history.json        # Conversion history (auto-generated)
```

## üîå API Endpoints

The application provides a RESTful API for programmatic access:

### Main Interface
- `GET /` - Main web interface

### Conversion Endpoints
- `POST /api/convert` - Start video/audio conversion (YouTube/TikTok/Discord)
  - Request body: `{"media_url": "https://...", "device": "cuda" | "cpu" | null}`
  - `device` parameter (optional): Specify "cuda" for GPU or "cpu" for CPU processing. If omitted or null, automatically selects based on CUDA availability.
  - Supported URLs: YouTube, TikTok, and Discord CDN links
  - Returns: `{"task_id": "...", "status": "queued"}`

- `GET /api/status/<task_id>` - Check conversion status
  - Returns: Status, progress, and result information

- `POST /api/stop/<task_id>` - Cancel a running conversion

### Sheet Conversion
- `POST /api/convert-to-sheets` - Convert MIDI to QWERTY sheets
  - Request body: `{"midi_filename": "...", "settings": {...}}`
  - Returns: Sheet text and download URL

### History & Health
- `GET /api/history` - Get conversion history
  - Query params: `limit` (default: 10)

- `POST /api/history/delete` - Delete a history item
  - Request body: `{"timestamp": <float>}`
  - Returns: `{"status": "success", "message": "History item deleted"}`

- `GET /api/health` - Health check endpoint

### Example API Usage

```bash
# Start a conversion (auto-select device)
curl -X POST http://127.0.0.1:5000/api/convert \
  -H "Content-Type: application/json" \
  -d '{"media_url": "https://www.youtube.com/watch?v=..."}'

# Start a conversion with CPU
curl -X POST http://127.0.0.1:5000/api/convert \
  -H "Content-Type: application/json" \
  -d '{"media_url": "https://www.youtube.com/watch?v=...", "device": "cpu"}'

# Start a conversion with CUDA
curl -X POST http://127.0.0.1:5000/api/convert \
  -H "Content-Type: application/json" \
  -d '{"media_url": "https://www.youtube.com/watch?v=...", "device": "cuda"}'

# Convert from Discord CDN link
curl -X POST http://127.0.0.1:5000/api/convert \
  -H "Content-Type: application/json" \
  -d '{"media_url": "https://cdn.discordapp.com/attachments/...", "device": "cuda"}'

# Check status
curl http://127.0.0.1:5000/api/status/<task_id>

# Convert MIDI to sheets
curl -X POST http://127.0.0.1:5000/api/convert-to-sheets \
  -H "Content-Type: application/json" \
  -d '{"midi_filename": "song_transkun.mid", "settings": {}}'
```

## üêõ Troubleshooting

### Common Issues

#### ‚ùå "Transkun not found"
- Ensure Transkun is installed and in your system PATH
- Verify with: `transkun --version`
- Check that the executable is accessible from your terminal

#### ‚ùå "CUDA not available"
- The application works on CPU, but will be slower
- You can manually select CPU mode using the toggle switch in the interface
- If CUDA is selected but not available, the system automatically falls back to CPU
- For GPU support, ensure:
  - CUDA-capable GPU is installed
  - PyTorch with CUDA support is installed
  - CUDA drivers are up to date

#### ‚ùå "FFmpeg not found"
- Install FFmpeg and add it to your system PATH
- Verify with: `ffmpeg -version`

#### ‚ùå "Conversion timeout"
- Large files may take longer to process
- Check your system resources (CPU/GPU usage)
- Try converting smaller audio segments

#### ‚ùå "Download failed" (YouTube/TikTok/Discord)
- Check your internet connection
- Verify the URL is correct and accessible
- Some videos may have restrictions
- For YouTube: Try using a cookies file (place `cookies.txt` in project root)
- For Discord: Ensure the CDN link is valid and not expired

### Performance Tips

- üöÄ Use a CUDA-capable GPU for faster conversions
- üíæ Ensure sufficient disk space for uploads and conversions
- üåê Stable internet connection for video downloads
- üîß Close other resource-intensive applications during conversion

## üîí Security Notes

- The application runs on `127.0.0.1` by default (localhost only)
- For production deployment, use proper security measures:
  - Set a strong `SECRET_KEY`
  - Enable HTTPS with `FORCE_HTTPS=true`
  - Configure firewall rules
  - Use a reverse proxy (nginx, Apache)
  - Implement rate limiting (already included)

## üìù License

This project is open source and available under the MIT License.

## üôè Credits

- üéπ **QWERTY Sheet Converter**: Based on [midi-converter](https://github.com/ArijanJ/midi-converter) by [@ArijanJ](https://github.com/ArijanJ) and [@Albacusphetical](https://github.com/Albacusphetical)
- üéµ **Transkun**: For [audio-to-MIDI transcription](https://github.com/Yujia-Yan/Transkun?tab=readme-ov-file)
- üé® **UI Framework**: Built with Flask, Tailwind CSS, and modern web technologies

## ü§ù Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## üìß Support

For issues, questions, or feature requests, please open an issue on the GitHub repository.

---

**Made with ‚ù§Ô∏è for music enthusiasts**
